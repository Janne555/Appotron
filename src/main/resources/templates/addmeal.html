<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

    <head th:include="fragments :: head">
    </head>
    <head>
        <script>
            /*<![CDATA[*/
            $(document).on("keypress", "form", function(event) { 
                return event.keyCode != 13;
            });

            $(document).ready(function(){
                $("#scanbutton").click(function(){
                    var name = $("#name").val();
                    // console.log(encodeURIComponent(window.location.href));
                    var url = "http://zxing.appspot.com/scan?ret=" + encodeURIComponent(window.location.href) + "%3Fserial%3D%7BCODE%7D%26name%3D" + encodeURIComponent(name) + "&SCAN_FORMATS=UPC_A,EAN_13";
                    window.location.href = url;
            })});

            $(document).ready(function(){
                $("#removetagbutton").click(function(){
                    $("tr").remove(".w3-grey");
            })});

            $(document).ready(function(){
                $("#searchbutton").click(function(){
                    var xhr = new XMLHttpRequest();
                    var param = $("#searchfield").val();
                    xhr.open('GET', "/addmealsearch.get?param=" + param, true);
                    xhr.send();
                    xhr.addEventListener("readystatechange", processRequest, false);
                    xhr.onreadystatechange = processRequest;
                    var boolean = true;

                    function processRequest(e) {
                        if (xhr.readyState == 4 && xhr.status == 200 && boolean) {
                            $("#searchresults").empty();
                            var response = JSON.parse(xhr.responseText);
                            for (i in response) {
                                var name = response[i].name;
                                var identifier = response[i].globalReferenceId;
                                var result = "<li id='" + identifier + "' class='w3-list-item' data-identifier='" + identifier + "' data-itemname='" + name + "' onClick='chooseThis(this)'>" + name + ", " + identifier +"</li>";
                                $("#searchresults").append(result);
                            }
                            boolean = !boolean;
                            
                        }
                    }

                })
            });
            
            function chooseThis(something) {
                var itemname = something.dataset.itemname;
                var identifier = something.dataset.identifier;
                var row = "<tr id='row" + identifier + "'><td>" + itemname + "<input name='mealcomponents' value='" + identifier + "' hidden='true' /> </td><td><input class='w3-input' required='true' name='massforid:" + identifier + "' type='number' min='0' step='0.1' placeholder='grams' /></td><td><button class='w3-button' onClick='removeThis(" + '"row' + identifier + '"' + ")' type='button'>Remove</button></tr>";
                $("#selectionstable").append(row);
            }

            function removeThis(identifier) {
                $("#" + identifier).remove();
            }
            /*]]>*/

        </script>
    </head>
    <body>
    <div th:replace="fragments :: navigation">
    </div>
    <div class="w3-main">
    <div class="w3-col m10 l5 w3-card-4">
        <div class="w3-container w3-green">
            <h2>Meal</h2>
        </div>

        <div class="w3-container w3-margin w3-padding">
                <h3>Search for Foodstuffs</h3>
            <br />
            <div class="w3-container w3-cell" style="width: 90%">
                <input class="w3-input" type="text" name="searchfield" id="searchfield" />
            </div>
            <div class="w3-container w3-cell">   
                <button class="w3-button" id="searchbutton" >Search</button>
            </div>
            <br />
            <div>
                <ul class="w3-ul w3-hoverable" id="searchresults"></ul>
            </div>
        </div>


        <div class="w3-container w3-margin">
                <h3>Selected</h3>
        <br />
        <form class="w3-container" action="/addmeal.post" method="post">
            <div class="w3-responsive">
            <table id="selectionstable" class="w3-table-all">
                <tr>
                    <th>Name</th>
                    <th>Mass</th>
                    <th></th>
                </tr>
            </table>
            <br />
            </div>
            <div class="w3-row-padding">
                <div class="w3-half w3">
                    <input class="w3-button w3-block w3-teal" type="reset" name="reset" value="Reset" />
                </div>
                <div class="w3-half">
                    <input class="w3-button w3-block w3-teal" type="submit" name="submit" value="Submit" />
                </div>
            </div>
            <br />
        </form>
        </div>
    </div>
    </div>
    </body>
</html>