<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

    <head>
        <title>Add Item</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://www.w3schools.com/lib/w3.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script>
            /*<![CDATA[*/
            $(document).on("keypress", "form", function(event) { 
                return event.keyCode != 13;
            });

            $(document).ready(function(){
                $("#tagstable").on("click", "tr", function(){
                    if ($(this).attr("class") != "header") {
                        $(this).addClass('w3-grey').siblings().removeClass('w3-grey');
                    }
            })});

            $(document).ready(function(){
                $("#scanbutton").click(function(){
                    var name = $("#name").val();
                    // console.log(encodeURIComponent(window.location.href));
                    var url = "http://zxing.appspot.com/scan?ret=" + encodeURIComponent(window.location.href) + "%3Fserial%3D%7BCODE%7D%26name%3D" + encodeURIComponent(name) + "&SCAN_FORMATS=UPC_A,EAN_13";
                    window.location.href = url;
            })});

            $(document).ready(function(){
                $("#removetagbutton").click(function(){
                    $("tr").remove(".w3-grey");
            })});


            //BUG YOU CAN ENTER MULTIPLE TAGS WITH THE SAME KEY!!!
            $(document).ready(function(){
                $("#addbutton").click(function(){
                    var item = $("#searchresults option:selected");
                    var mass = $("#mass").val();
                    if (mass > 0) {
                    	var list = $("#ingredientslist");
                    	var listitem = document.createElement("li");
                    	listitem.innerHTML = mass + " g. " + item.text() + ", " + item.attr("name") + "<input type='text' name='ingredients[]' hidden='true' value='mass:" + mass + ",serialNumber:" + item.attr("name") + "' />";
                    	list.append(listitem);
                    } else {
                        alert("Field(s) can't be empty!")
                    }
            })});

            $(document).ready(function(){
                $("#typechooser").change(function(){
                    var val = $("#typechooser").val();
                    if (val == "foodstuff") {
                        $("#datepicker").show();
                    } else {
                        $("#datepicker").hide();
                    }
            })});

            $(document).ready(function(){
                $("#searchbutton").click(function(){
                    var xhr = new XMLHttpRequest();
                    var param = $("#search").val();
                    console.log(param);
                    xhr.open('GET', "/ingredients.get?param=" + param, true);
                    xhr.send();
                    xhr.addEventListener("readystatechange", processRequest, false);
                    xhr.onreadystatechange = processRequest;
                    var boolean = true;

                    function processRequest(e) {
                        if (xhr.readyState == 4 && xhr.status == 200 && boolean) {
                            var response = JSON.parse(xhr.responseText);
                            for (i in response) {
                                var list = document.getElementById("searchresults");
                                var option = document.createElement("option");
                                option.innerHTML = response[i].name;
                                option.setAttribute("name", response[i].serialNumber);
                                list.appendChild(option);
                            }
                            boolean = !boolean;
                            
                        }
                    }

                })
            });
            /*]]>*/

        </script>
        <style>
        </style>
    </head>
    <body>
    <div th:replace="fragments :: navigation">
    </div>
    <div class="w3-main">
    <div class="w3-col m6 l4 w3-card-4 w3-margin">
        <form class="w3-container" action="/addmeal.post" method="post">
        <br />
            <div class="w3-container w3-green">
                <h2>Basic Info</h2>
            </div>
            <label class="w3-label" for="name">Name:</label>
            <input class="w3-input" type="text" name="name" required="true" id="name" th:value="${namefield}" /><br />
            <label class="w3-label" for="type">Type:</label>
            <input class="w3-input" list="typelist" required="true" name="type" id="type" /><br />
            <datalist id="typelist">    
                <option th:each="type: ${types}" th:value="${type}" />
            </datalist>
            <div class="w3-container w3-green">
            	<h2>Ingredients</h2>
            </div>
            <label class="w3-label" for="search">Search for Ingredients:</label><br />
            <input class="w3-input" type="text" name="search" required="true" id="search"/><br />
            <div class="w3-row-padding">
				 <div class="w3-half">
				    <input class="w3-input w3-border w3-teal" type="button" id="scanbutton" disabled="true" value="Scan for Barcode" />
				 </div>
				 <div class="w3-half">
				    <input class="w3-input w3-border w3-teal" type="button" id="searchbutton" value="Search" />
				 </div>
			</div><br />

			<div class="w3-row-padding">
				<div class="w3-third">
					<label class="w3-label" for="searchresults">Search Results:</label>
                	<select class="w3-select" name="type" id="searchresults" required="true">
                  		<option value="" disabled="true" selected="true">Choose type</option>
                	</select><br/>
				</div>
				<div class="w3-third">
					<label class="w3-label" for="mass">Mass (grams):</label>
				    <input class="w3-input" type="number" name="mass" id="mass" step="0.01" min="0" /><br/>
				</div>
				<div class="w3-third">
					<label class="w3-label">lol</label>
					<input class="w3-input w3-border w3-teal" type="button" id="addbutton" value="Add" />
				</div>

			</div>
			<label class="w3-label" for="search">List of Ingredients:</label><br />
            <ul class="w3-ul" id="ingredientslist">
            	<li th:each="ingredient: ${ingredients}" th:text="${ingredient}">
            		<input type="text" name="ingredients[]" hidden="true" th:value="${ingredient}" />
            	</li>
            </ul>
            <input class="w3-button w3-block w3-teal" type="submit" name="submit" value="Submit" /> <br />
            <input class="w3-button w3-block w3-teal" type="reset" name="reset" value="Reset" /> <br />
        </form>
    </div>
    </div>
    </body>
</html>